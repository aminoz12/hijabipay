{% extends "base.html" %}

{% set hide_nav = true %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="w-full max-w-2xl">
        <!-- Logo -->
        <div class="text-center mb-8">
            <a href="{{ url_for('index') }}" class="inline-block">
                <img class="h-12 w-auto" src="{{ url_for('static', filename='images/logo.png') }}" alt="HijabiPay">
            </a>
        </div>
        
        <!-- Progress Steps -->
        <div class="flex justify-between items-center mb-8 px-8">
            <div class="flex flex-col items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 text-white font-medium">1</div>
                <span class="mt-2 text-sm font-medium text-gray-700">Détails</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
            <div class="flex flex-col items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 bg-white text-gray-500 font-medium">2</div>
                <span class="mt-2 text-sm font-medium text-gray-500">Paiement</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
            <div class="flex flex-col items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 bg-white text-gray-500 font-medium">3</div>
                <span class="mt-2 text-sm font-medium text-gray-500">Confirmation</span>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 sm:p-8">
            <div class="mb-8">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Finalisez votre achat</h1>
                    <div class="inline-flex items-center px-3 py-1 rounded-full bg-blue-50 border border-blue-200">
                        <svg class="w-4 h-4 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span class="text-sm font-medium text-blue-700">Commande #{{ unique_id }}</span>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Récapitulatif de la commande
                    </h2>
                    
                    <div class="bg-white rounded-xl p-5 space-y-4 shadow-sm">
                        <div class="flex items-start justify-between pb-3 border-b border-gray-100">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">Produit</p>
                                    <p class="font-semibold text-gray-900 mt-1">{{ product_name }}</p>
                                </div>
                            </div>
                            <span class="text-lg font-bold text-gray-900">{{ "%.2f"|format(price) }} €</span>
                        </div>
                        
                        <div class="flex items-center justify-between py-2">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                                </svg>
                                <span class="text-sm text-gray-600">Méthode de livraison</span>
                            </div>
                            <span class="font-medium text-gray-900">{{ delivery_method }}</span>
                        </div>
                        
                        <div class="flex items-center justify-between py-2">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
                                </svg>
                                <span class="text-sm text-gray-600">Frais de livraison</span>
                            </div>
                            <span class="{% if delivery_cost > 0 %}font-medium text-gray-900{% else %}text-green-600 font-semibold flex items-center{% endif %}">
                                {% if delivery_cost > 0 %}
                                    {{ "%.2f"|format(delivery_cost) }} €
                                {% else %}
                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    Gratuit
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="pt-4 mt-2 border-t-2 border-gray-200">
                            <div class="flex justify-between items-center bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg p-4 text-white">
                                <span class="text-lg font-bold uppercase tracking-wide">Total à payer</span>
                                <div class="text-right">
                                    <div class="text-3xl font-bold">{{ "%.2f"|format(total_amount) }} €</div>
                                    <div class="text-xs opacity-90 mt-1">TTC</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-2 flex items-center">
                        <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        Méthode de paiement
                    </h2>
                    <p class="text-sm text-gray-500 ml-8">Choisissez votre mode de paiement sécurisé</p>
                </div>
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="mb-4 p-4 rounded-xl bg-{{ 'red' if category == 'error' else 'green' }}-50 border border-{{ 'red' if category == 'error' else 'green' }}-200">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-{{ 'red' if category == 'error' else 'green' }}-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-{{ 'red' if category == 'error' else 'green' }}-800">{{ message }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Payment Methods -->
                <div class="space-y-4">
                    <!-- PayPal Button Container -->
                    <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-2xl p-6 border-2 border-blue-200 shadow-lg">
                        <div class="flex items-center justify-center mb-4">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm font-semibold text-gray-700">Paiement 100% sécurisé</span>
                            </div>
                        </div>
                        
                        <div id="paypal-button-container" class="bg-white rounded-xl p-6 shadow-sm" style="min-height: 150px;">
                            <div class="text-center py-8">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-3 border-blue-600 mx-auto"></div>
                                <p class="mt-4 text-sm font-medium text-gray-600">Chargement des options de paiement...</p>
                                <div class="mt-3 flex items-center justify-center space-x-2">
                                    <svg class="w-8 h-8" viewBox="0 0 124 33" fill="none">
                                        <path d="M46.211 6.749h-6.839a.95.95 0 0 0-.939.802l-2.766 17.537a.57.57 0 0 0 .564.658h3.265a.95.95 0 0 0 .939-.803l.746-4.73a.95.95 0 0 1 .938-.803h2.165c4.505 0 7.105-2.18 7.784-6.5.306-1.89.013-3.375-.872-4.415-.972-1.142-2.696-1.746-4.985-1.746zM47 13.154c-.374 2.454-2.249 2.454-4.062 2.454h-1.032l.724-4.583a.57.57 0 0 1 .563-.481h.473c1.235 0 2.4 0 3.002.704.359.42.469 1.044.332 1.906zM66.654 13.075h-3.275a.57.57 0 0 0-.563.481l-.145.916-.229-.332c-.709-1.029-2.29-1.373-3.868-1.373-3.619 0-6.71 2.741-7.312 6.586-.313 1.918.132 3.752 1.22 5.031.998 1.176 2.426 1.666 4.125 1.666 2.916 0 4.533-1.875 4.533-1.875l-.146.91a.57.57 0 0 0 .562.66h2.95a.95.95 0 0 0 .939-.803l1.77-11.209a.568.568 0 0 0-.561-.658zm-4.565 6.374c-.316 1.871-1.801 3.127-3.695 3.127-.951 0-1.711-.305-2.199-.883-.484-.574-.668-1.391-.514-2.301.295-1.855 1.805-3.152 3.67-3.152.93 0 1.686.309 2.184.892.499.589.697 1.411.554 2.317zM84.096 13.075h-3.291a.954.954 0 0 0-.787.417l-4.539 6.686-1.924-6.425a.953.953 0 0 0-.912-.678h-3.234a.57.57 0 0 0-.541.754l3.625 10.638-3.408 4.811a.57.57 0 0 0 .465.9h3.287a.949.949 0 0 0 .781-.408l10.946-15.8a.57.57 0 0 0-.468-.895z" fill="#253B80"/>
                                        <path d="M94.992 6.749h-6.84a.95.95 0 0 0-.938.802l-2.766 17.537a.569.569 0 0 0 .562.658h3.51a.665.665 0 0 0 .656-.562l.785-4.971a.95.95 0 0 1 .938-.803h2.164c4.506 0 7.105-2.18 7.785-6.5.307-1.89.012-3.375-.873-4.415-.971-1.142-2.694-1.746-4.983-1.746zm.789 6.405c-.373 2.454-2.248 2.454-4.062 2.454h-1.031l.725-4.583a.568.568 0 0 1 .562-.481h.473c1.234 0 2.4 0 3.002.704.359.42.468 1.044.331 1.906zM115.434 13.075h-3.273a.567.567 0 0 0-.562.481l-.145.916-.23-.332c-.709-1.029-2.289-1.373-3.867-1.373-3.619 0-6.709 2.741-7.311 6.586-.312 1.918.131 3.752 1.219 5.031 1 1.176 2.426 1.666 4.125 1.666 2.916 0 4.533-1.875 4.533-1.875l-.146.91a.57.57 0 0 0 .564.66h2.949a.95.95 0 0 0 .938-.803l1.771-11.209a.571.571 0 0 0-.565-.658zm-4.565 6.374c-.314 1.871-1.801 3.127-3.695 3.127-.949 0-1.711-.305-2.199-.883-.484-.574-.666-1.391-.514-2.301.297-1.855 1.805-3.152 3.67-3.152.93 0 1.686.309 2.184.892.501.589.699 1.411.554 2.317zM119.295 7.23l-2.807 17.858a.569.569 0 0 0 .562.658h2.822c.469 0 .867-.34.939-.803l2.768-17.536a.57.57 0 0 0-.562-.659h-3.16a.571.571 0 0 0-.562.482z" fill="#179BD7"/>
                                        <path d="M7.266 29.154l.523-3.322-1.165-.027H1.061L4.927 1.292a.316.316 0 0 1 .314-.268h9.38c3.114 0 5.263.648 6.385 1.927.526.6.861 1.227 1.023 1.917.17.724.173 1.589.007 2.644l-.012.077v.676l.526.298a3.69 3.69 0 0 1 1.065.812c.45.513.741 1.165.864 1.938.127.795.085 1.741-.123 2.812-.24 1.232-.628 2.305-1.152 3.183a6.547 6.547 0 0 1-1.825 2c-.696.494-1.523.869-2.458 1.109-.906.236-1.939.355-3.072.355h-.73c-.522 0-1.029.188-1.427.525a2.21 2.21 0 0 0-.744 1.328l-.055.299-.924 5.855-.042.215c-.011.068-.03.102-.058.125a.155.155 0 0 1-.096.035H7.266z" fill="#253B80"/>
                                        <path d="M23.048 7.667c-.028.179-.06.362-.096.55-1.237 6.351-5.469 8.545-10.874 8.545H9.326c-.661 0-1.218.48-1.321 1.132L6.596 26.83l-.399 2.533a.704.704 0 0 0 .695.814h4.881c.578 0 1.069-.42 1.16-.99l.048-.248.919-5.832.059-.32c.09-.572.582-.992 1.16-.992h.73c4.729 0 8.431-1.92 9.513-7.476.452-2.321.218-4.259-.978-5.622a4.667 4.667 0 0 0-1.336-1.03z" fill="#179BD7"/>
                                        <path d="M21.754 7.151a9.757 9.757 0 0 0-1.203-.267 15.284 15.284 0 0 0-2.426-.177h-7.352a1.172 1.172 0 0 0-1.159.992L8.05 17.605l-.045.289a1.336 1.336 0 0 1 1.321-1.132h2.752c5.405 0 9.637-2.195 10.874-8.545.037-.188.068-.371.096-.55a6.594 6.594 0 0 0-1.017-.429 9.045 9.045 0 0 0-.277-.087z" fill="#222D65"/>
                                        <path d="M9.614 7.699a1.169 1.169 0 0 1 1.159-.991h7.352c.871 0 1.684.057 2.426.177a9.757 9.757 0 0 1 1.481.353c.365.121.704.264 1.017.429.368-2.347-.003-3.945-1.272-5.392C20.378.682 17.853 0 14.622 0h-9.38c-.66 0-1.223.48-1.325 1.133L.01 25.898a.806.806 0 0 0 .795.932h5.791l1.454-9.225 1.564-9.906z" fill="#253B80"/>
                                    </svg>
                                    <span class="text-xs text-gray-400">•</span>
                                    <svg class="w-12 h-8" viewBox="0 0 48 32">
                                        <path fill="#00579F" d="M0 3.5A3.5 3.5 0 013.5 0h41A3.5 3.5 0 0148 3.5v25a3.5 3.5 0 01-3.5 3.5h-41A3.5 3.5 0 010 28.5v-25z"/>
                                        <path fill="#EF9F00" d="M24 25.5c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7z"/>
                                        <path fill="#FF5F00" d="M21 18.5c0-2.52 1.34-4.73 3.35-5.96A7.003 7.003 0 0017 18.5c0 2.52 1.34 4.73 3.35 5.96A6.99 6.99 0 0021 18.5z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex items-center justify-center text-xs text-gray-500">
                            <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Vous serez redirigé vers une page sécurisée pour finaliser votre paiement
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-6 text-center space-y-2">
        <p class="text-sm text-gray-700 font-medium">
            Besoin d'aide ?
        </p>
        <a href="http://wa.me/33626157421" target="_blank" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.966-.273-.099-.471-.148-.67.15-.197.297-.767.963-.94 1.16-.174.196-.347.223-.644.075-.297-.15-1.263-.465-2.403-1.485-.888-.795-1.484-1.76-1.66-2.06-.173-.297-.018-.458.13-.606.136-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.611-.916-2.207-.242-.579-.487-.5-.669-.508-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.361.195 1.871.118.571-.085 1.758-.719 2.005-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.142 1.595 5.945L0 24l6.335-1.652a11.882 11.882 0 005.723 1.465h.005c6.554 0 11.89-5.335 11.89-11.893 0-3.18-1.261-6.172-3.53-8.421z"></path>
            </svg>
            Contactez-nous par WhatsApp
        </a>
    </div>

{% endblock %}

{% block scripts %}
<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=EUR&intent=capture&commit=true&components=buttons,card-fields&enable-funding=paypal,card&disable-funding=venmo&locale=fr_FR"
    crossorigin="anonymous">
</script>

<script>
    // Function to show error messages
    function showError(message) {
        console.error('Payment Error:', message);
        const container = document.getElementById('paypal-button-container');
        if (container) {
            container.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700">${message}</p>
                            <button onclick="window.location.reload()" class="mt-2 text-sm font-medium text-red-600 hover:text-red-500">
                                Réessayer <span aria-hidden="true">&rarr;</span>
                            </button>
                        </div>
                    </div>
                </div>`;
        } else {
            console.error('Error container not found');
            const shouldReload = confirm('Erreur: ' + message + '\n\nVoulez-vous réessayer?');
            if (shouldReload) {
                window.location.reload();
            }
        }
    }

    // Initialize PayPal Buttons
    function initializePayPalButtons() {
        console.log('Initializing PayPal buttons...');
        
        const container = document.getElementById('paypal-button-container');
        if (!container) {
            console.error('PayPal container not found');
            showError('Erreur d\'initialisation du paiement. Veuillez réessayer.');
            return;
        }
        
        // Check if PayPal SDK is loaded
        if (typeof paypal === 'undefined') {
            showError('Le système de paiement n\'a pas pu être chargé. Veuillez réessayer.');
            return;
        }
        
        try {
            // Clear any existing content
            container.innerHTML = '';
            
            // Check if card-fields component is available
            const hasCardFields = typeof paypal.CardFields !== 'undefined';
            console.log('Card fields available:', hasCardFields);
            
            // Create PayPal button
            paypal.Buttons({
                // Button styling
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    label: 'pay',
                    height: 45,
                    tagline: false
                },
                
                // Funding sources
                fundingSource: undefined, // Allow all funding sources
                
                // Create order on server
                createOrder: function(data, actions) {
                    console.log('Creating PayPal order...');
                    
                    // Don't manipulate the DOM here - it breaks the PayPal flow
                    // Just create the order
                    
                    // Create order on server
                    return fetch('/create-paypal-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                        },
                        body: JSON.stringify({
                            unique_id: '{{ unique_id }}'
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(text || 'Failed to create order');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Order created - Full response:', data);
                        console.log('Order created - Type:', typeof data);
                        console.log('Order created - Keys:', Object.keys(data));
                        console.log('Order created - orderID:', data.orderID);
                        console.log('Order created - status:', data.status);
                        
                        if (!data.orderID) {
                            console.error('ERROR: No orderID in response!', data);
                            throw new Error('No order ID received');
                        }
                        
                        console.log('Returning orderID to PayPal:', data.orderID);
                        return data.orderID;
                    })
                    .catch(error => {
                        console.error('Error creating order:', error);
                        showError('Erreur lors de la création de la commande. Veuillez réessayer.');
                        throw error;
                    });
                },
                
                // Handle successful payment approval
                onApprove: function(data, actions) {
                    console.log('Capturing PayPal order:', data.orderID);
                    console.log('Payment approved! Processing...');
                    
                    // Don't manipulate DOM - let PayPal handle the UI
                    
                    // Send capture request to server
                    return fetch('/capture-paypal-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                        },
                        body: JSON.stringify({
                            orderID: data.orderID,
                            unique_id: '{{ unique_id }}'
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(text || 'Failed to capture order');
                            });
                        }
                        return response.json();
                    })
                    .then(orderData => {
                        console.log('Payment successful:', orderData);
                        // Redirect to success page
                        if (orderData.redirect) {
                            window.location.href = orderData.redirect;
                        } else {
                            window.location.href = '{{ url_for("payment_success", unique_id=unique_id) }}';
                        }
                    })
                    .catch(error => {
                        console.error('Error capturing payment:', error);
                        showError('Erreur lors du traitement du paiement. Veuillez réessayer.');
                    });
                },
                
                // Handle errors
                onError: function(err) {
                    console.error('PayPal error:', err);
                    showError('Une erreur est survenue avec le système de paiement. Veuillez réessayer.');
                },
                
                // Handle cancellation
                onCancel: function(data) {
                    console.log('Payment cancelled:', data);
                    // Reset the button
                    initializePayPalButtons();
                }
            }).render('#paypal-button-container');
            
            console.log('PayPal buttons initialized successfully');
            
        } catch (error) {
            console.error('Error initializing PayPal buttons:', error);
            showError('Erreur d\'initialisation du paiement. Veuillez réessayer.');
        }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, starting PayPal integration...');
        
        // Check if PayPal SDK is already loaded
        if (typeof paypal !== 'undefined') {
            console.log('PayPal SDK already loaded, initializing buttons...');
            initializePayPalButtons();
        } else {
            console.log('Waiting for PayPal SDK to load...');
            
            // Set a timeout to handle cases where the SDK fails to load
            const loadTimeout = setTimeout(function() {
                if (typeof paypal === 'undefined') {
                    console.error('PayPal SDK failed to load within timeout');
                    showError('Le système de paiement a mis trop de temps à se charger. Veuillez rafraîchir la page ou essayer plus tard.');
                }
            }, 10000); // 10 seconds timeout
            
            // Poll for PayPal SDK
            const checkInterval = setInterval(function() {
                if (typeof paypal !== 'undefined') {
                    clearInterval(checkInterval);
                    clearTimeout(loadTimeout);
                    console.log('PayPal SDK loaded, initializing buttons...');
                    initializePayPalButtons();
                }
            }, 100);
        }
    });
</script>
{% endblock %}
